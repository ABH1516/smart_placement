{% extends "tracker/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">

    <h2 class="text-center mb-4 fw-bold text-primary">üìù Mock Interview Bot</h2>

    <!-- Settings Card -->
    <div class="card shadow-sm p-4 mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-md-6">
                <label for="role" class="form-label fw-semibold">Select Interview Type:</label>
                <select id="role" class="form-select">
                    <option value="HR">HR</option>
                    <option value="Technical">Technical</option>
                    <option value="Resume">Resume-Based</option>
                </select>
            </div>

            <div class="col-md-6 d-flex align-items-center mt-2 mt-md-0">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enable-timer">
                    <label class="form-check-label fw-semibold" for="enable-timer">
                        Enable Timer (60s per question)
                    </label>
                </div>
            </div>

            <div class="col-12 text-center mt-3">
                <button id="start-btn" class="btn btn-success btn-lg shadow-sm">üöÄ Start Interview</button>
            </div>
        </div>
    </div>

</div>

<!-- Interview Modal -->
<div class="modal fade" id="interviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Interview Question</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4" id="question-container" style="min-height: 150px;">
        <!-- Question content injected here -->
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <p id="timer" class="text-danger fw-bold me-auto"></p>
        <button id="next-btn" class="btn btn-success">Next</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Custom CSS -->
<style>
    #question-container p {
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    #answer-text {
        border-radius: 0.5rem;
        font-size: 1rem;
    }

    #next-btn {
        min-width: 120px;
    }

    /* Hover effect for buttons */
    .btn:hover {
        transform: scale(1.05);
        transition: 0.2s;
    }

    /* Modal fade-in */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: translateY(-50px);
    }

    .modal.show .modal-dialog {
        transform: translateY(0);
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        #answer-text {
            font-size: 0.95rem;
        }
        #start-btn {
            width: 100%;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let questions = [];
let currentIndex = 0;
let timerInterval;

document.getElementById('start-btn').addEventListener('click', async () => {
    const role = document.getElementById('role').value;

    try {
        const response = await fetch("{% url 'start_interview' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ role })
        });

        const data = await response.json();
        if(data.error){
            alert("Error: " + data.error);
            return;
        }

        questions = data.questions;
        currentIndex = 0;

        showQuestion(currentIndex);

        const modal = new bootstrap.Modal(document.getElementById('interviewModal'));
        modal.show();

    } catch(err){
        alert("Failed to fetch questions");
        console.error(err);
    }
});

function showQuestion(index) {
    const container = document.getElementById('question-container');
    const nextBtn = document.getElementById('next-btn');

    if(timerInterval) clearInterval(timerInterval);
    const enableTimer = document.getElementById('enable-timer').checked;

    if(index >= questions.length){
        container.innerHTML = "<p class='text-center fw-bold text-success'>üéâ All questions completed!</p>";
        nextBtn.style.display = 'none';
        document.getElementById('timer').textContent = '';
        return;
    }

    const q = questions[index];
    container.innerHTML = `
        <p><strong>Q${index + 1}:</strong> ${q.text}</p>
        <textarea class="form-control mb-2" id="answer-text" rows="4" placeholder="Type your answer here..."></textarea>
        <p id="status-text" class="mt-2 text-success fw-bold"></p>
    `;

    nextBtn.style.display = 'inline-block';
    nextBtn.textContent = index === questions.length - 1 ? "Finish" : "Next";

    // Timer
    if(enableTimer){
        let remaining = 60;
        const timerEl = document.getElementById('timer');
        timerEl.textContent = `‚è± Time left: ${remaining}s`;
        timerInterval = setInterval(() => {
            remaining--;
            timerEl.textContent = `‚è± Time left: ${remaining}s`;
            if(remaining <= 0){
                clearInterval(timerInterval);
                nextBtn.click();
            }
        }, 1000);
    }
}

document.getElementById('next-btn').addEventListener('click', async () => {
    const q = questions[currentIndex];
    const answer = document.getElementById('answer-text').value;
    const statusText = document.getElementById('status-text');

    if(answer.trim() === ""){
        statusText.textContent = "‚ö†Ô∏è Please enter an answer before proceeding.";
        return;
    }

    try {
        const res = await fetch("{% url 'submit_answer' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ id: q.id, answer })
        });

        const result = await res.json();
        if(result.error){
            statusText.textContent = "‚ùå Error submitting answer: " + result.error;
            return;
        } else {
            statusText.textContent = "‚úÖ Answer submitted!";
        }

        setTimeout(() => {
            currentIndex++;
            showQuestion(currentIndex);
        }, 500);

    } catch(err){
        statusText.textContent = "‚ùå Error submitting answer.";
        console.error(err);
    }
});
</script>

{% endblock %}
